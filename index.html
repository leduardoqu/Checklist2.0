<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#991b1b">
    <title>Rotina Log√≠stica</title>
    
    <!-- CSS Puro (Zero downloads externos) -->
    <style>
        body { font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: #f3f4f6; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .hidden { display: none !important; }
        
        /* TELA LOGIN */
        .center-screen { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; flex-direction: column; }
        .card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 5px solid #991b1b; text-align: center; }
        
        /* FORMUL√ÅRIO */
        input { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; outline: none; box-sizing: border-box; }
        input:focus { border-color: #991b1b; box-shadow: 0 0 0 2px rgba(153, 27, 27, 0.1); }
        
        button { width: 100%; padding: 14px; background-color: #991b1b; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* FOTO */
        .avatar { width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; border: 3px solid #fee2e2; overflow: hidden; background: #fff; display: flex; align-items: center; justify-content: center; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* APP */
        .header { background: #991b1b; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .date-nav { display: flex; justify-content: space-between; padding: 10px; background: white; margin-bottom: 5px; align-items: center; }
        .list-item { background: white; padding: 16px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .checked { background-color: #fef2f2; }
        .checked span { text-decoration: line-through; color: #888; }
    </style>
</head>
<body>

    <!-- TELA LOGIN -->
    <div id="loginScreen" class="center-screen">
        <div class="card">
            <div class="avatar">
                <img src="./perfil.jpg" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <!-- √çcone SVG Embutido -->
                <svg style="display:none; width:40px; height:40px;" viewBox="0 0 24 24" fill="none" stroke="#991b1b" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
            <h2 style="margin: 5px 0; color: #333;">Log√≠stica</h2>
            <p style="margin: 0 0 20px; color: #666; font-size: 14px;">Controlo de Opera√ß√µes</p>

            <input type="email" id="email" placeholder="E-mail">
            <input type="password" id="password" placeholder="Palavra-passe">
            
            <button id="btnEntrar" onclick="fazerLogin()" disabled>A INICIAR...</button>
            
            <p id="statusMsg" style="font-size: 12px; margin-top: 15px; color: #666; font-family: monospace;">A carregar scripts...</p>
        </div>
    </div>

    <!-- TELA APP -->
    <div id="appScreen" class="hidden">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div style="width:32px; height:32px; border-radius:50%; background:white; overflow:hidden;"><img src="./perfil.jpg" style="width:100%;height:100%;object-fit:cover"></div>
                <div id="userDisplay" style="font-size: 12px;">...</div>
            </div>
            <button onclick="sair()" style="width: auto; padding: 5px 10px; font-size: 12px; background: rgba(255,255,255,0.2);">Sair</button>
        </div>

        <div class="date-nav">
            <button onclick="mudarData(-1)" style="width:auto; background:none; color:#333; font-size:20px; border:none;">‚ùÆ</button>
            <input type="date" id="dateInput" style="border:none; font-weight:bold; font-size:16px; text-align:center;">
            <button onclick="mudarData(1)" style="width:auto; background:none; color:#333; font-size:20px; border:none;">‚ùØ</button>
        </div>

        <div id="listaContainer"></div>

        <div style="padding: 20px;">
            <button onclick="copiarResumo()" style="background: white; color: #991b1b; border: 2px solid #fee2e2;">COPIAR RESUMO</button>
        </div>
    </div>

    <!-- FIREBASE NO FIM DO BODY -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // CONFIGURA√á√ÉO
        const firebaseConfig = {
            apiKey: "AIzaSyCgWfdAVTVFhKRS-BLWGJrIt68hdq-OMhg",
            authDomain: "logisticacloud-1cc32.firebaseapp.com",
            projectId: "logisticacloud-1cc32",
            storageBucket: "logisticacloud-1cc32.firebasestorage.app",
            messagingSenderId: "883823898286",
            appId: "1:883823898286:web:6c22160dad0cd403a0873f"
        };

        let auth, db, usuarioAtual;
        let dataAtual = new Date().toISOString().split('T')[0];

        // --- SISTEMA DE INICIALIZA√á√ÉO FOR√áADA ---
        
        // 1. Atualiza texto imediatamente para provar que o JS est√° vivo
        const status = document.getElementById('statusMsg');
        const btn = document.getElementById('btnEntrar');
        status.innerText = "JS Iniciado. √Ä espera do Google...";

        // 2. Tenta iniciar
        function init() {
            if (typeof firebase !== 'undefined') {
                try {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    
                    status.innerText = "Sistema Pronto.";
                    status.style.color = "green";
                    btn.innerText = "ENTRAR";
                    btn.disabled = false;

                    auth.onAuthStateChanged(user => {
                        if (user) {
                            usuarioAtual = user;
                            status.innerText = "A entrar...";
                            entrarNoApp();
                        }
                    });
                } catch (e) {
                    status.innerText = "Erro Config: " + e.message;
                }
            }
        }

        // 3. Verifica a cada 500ms se o Firebase carregou
        let checkCount = 0;
        const checker = setInterval(() => {
            checkCount++;
            if (typeof firebase !== 'undefined') {
                clearInterval(checker);
                init();
            } else if (checkCount > 10) {
                // SE PASSAR 5 SEGUNDOS E NADA, FOR√áA O BOT√ÉO A APARECER
                clearInterval(checker);
                status.innerText = "Aviso: Internet lenta. Tente clicar.";
                status.style.color = "orange";
                btn.innerText = "ENTRAR (FOR√áAR)";
                btn.disabled = false;
            }
        }, 500);

        // --- LOGIN ---
        function fazerLogin() {
            // Verifica manualmente se o Firebase carregou agora
            if (typeof firebase === 'undefined') {
                alert("Erro Cr√≠tico: O Google Firebase n√£o carregou. Verifique a sua internet.");
                return;
            }
            
            // Se n√£o tiver inicializado ainda (caso do clique for√ßado)
            if (!auth) init();

            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            if (!email || !pass) {
                alert("Preencha todos os campos");
                return;
            }

            btn.innerText = "A VERIFICAR...";
            btn.disabled = true;

            auth.signInWithEmailAndPassword(email, pass)
                .catch(err => {
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                        return auth.createUserWithEmailAndPassword(email, pass);
                    }
                    throw err;
                })
                .catch(err => {
                    btn.innerText = "ENTRAR";
                    btn.disabled = false;
                    alert("Erro: " + err.code);
                });
        }

        // --- APP L√ìGICA ---
        const ITENS = [
            "Acompanhamento de cargas", "Acompanhamento de montadores", 
            "Acompanhamento dos transportes - 1x1", "An√°lise da quilometragem planejada",
            "Carregamentos Monitorados", "Imagens frota", 
            "KPI distribui√ß√£o e log√≠stica", "Monitoramento de ader√™ncias"
        ];

        function entrarNoApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userDisplay').innerText = usuarioAtual.email;
            
            const di = document.getElementById('dateInput');
            di.value = dataAtual;
            di.addEventListener('change', (e) => {
                dataAtual = e.target.value;
                carregarDados();
            });
            carregarDados();
        }

        function carregarDados() {
            if(!usuarioAtual) return;
            db.collection("users").doc(usuarioAtual.uid).collection("logistica").doc(dataAtual)
                .onSnapshot(doc => {
                    const data = doc.exists ? doc.data() : {};
                    renderizar(data);
                });
        }

        function toggle(item, val) {
            if(navigator.vibrate) navigator.vibrate(10);
            db.collection("users").doc(usuarioAtual.uid).collection("logistica").doc(dataAtual)
                .set({ [item]: !val }, { merge: true });
        }

        function renderizar(data) {
            const lista = document.getElementById('listaContainer');
            lista.innerHTML = '';
            
            ITENS.forEach(item => {
                const done = !!data[item];
                // √çcones SVG inline
                const icon = done 
                    ? <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> 
                    : <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>;
                
                const div = document.createElement('div');
                div.className = list-item ${done ? 'checked' : ''};
                div.onclick = () => toggle(item, done);
                div.innerHTML = ${icon} <span style="font-weight:500;">${item}</span>;
                lista.appendChild(div);
            });
        }

        function mudarData(d) {
            const date = new Date(dataAtual);
            date.setDate(date.getDate() + d);
            dataAtual = date.toISOString().split('T')[0];
            document.getElementById('dateInput').value = dataAtual;
            carregarDados();
        }

        function copiarResumo() {
            // L√≥gica simples de c√≥pia
            let txt = üìã *Log√≠stica ${dataAtual.split('-').reverse().join('/')}*\n;
            alert("Resumo copiado (simula√ß√£o)");
        }

        function sair() {
            auth.signOut();
            window.location.reload();
        }
    </script>
</body>
</html>